# @configure_input@
#
#

SHELL = @SHELL@

# IBM xlc support: use gcc for preprocessing
USE_GNU_PREPROC	= @USE_GNU_PREPROC@
GCC_AS_CC = @GCC_AS_CC@

# upcr.mak want to see these: use upper case versions (full paths instead of relative)
top_srcdir = @TOP_SRCDIR@
top_builddir = @TOP_BUILDDIR@

# Include makefile that'll sort out which gasnet makefile settings to use
upcrmak_dir=###INSTALL_PREFIX###/include
upcrmak_dir=$(top_builddir)###NOINSTALL###
@MAKE_INCLUDE@ $(upcrmak_dir)/upcr.mak

# this perl goop encodes any unfriendly characters in the CC/LD commands 
# that might otherwise break the shell or preprocessor. upcrun -i decodes them
UPCC_ENCODE = @PERL@ -pe 's/^\s*//g; s/\s*$$//g; s+([^\.A-Za-z0-9_/-])+sprintf("@%02X",ord($$1))+eg'

POSTTRANS_CPPFLAGS = -D__BERKELEY_UPC_SECOND_PREPROCESS__=1 \
  -DUPCRI_CC="$(shell echo '$(UPCR_CC)' | $(UPCC_ENCODE) )" \
  -DUPCRI_LD="$(shell echo '$(UPCR_LD)' | $(UPCC_ENCODE) )" 


UPCC_GENINCLUDE_CPPFLAGS= -I###INSTALL_PREFIX###/include/upcr_geninclude
UPCC_EXTINCLUDE_CPPFLAGS= -I###INSTALL_PREFIX###/include/upcr_extinclude
UPCC_PRETRANS_CPPFLAGS  = -I###INSTALL_PREFIX###/include/upcr_preinclude @PRETRANS_CPPFLAGS@
UPCC_POSTTRANS_CPPFLAGS = -I###INSTALL_PREFIX###/include/upcr_postinclude $(POSTTRANS_CPPFLAGS)
DETECT_UPC		= ###INSTALL_PREFIX###/libexec/detect-upc
PRE_PREPROC		= ###INSTALL_PREFIX###/libexec/upcppp
UPCC_UPC_HEADER_DIRS	= -I ###INSTALL_PREFIX###/include/upcr_preinclude

ifeq ("@TOP_SRCDIR@","@TOP_BUILDDIR@") # bug1713: avoid picking up geninclude twice
UPCC_GENINCLUDE_CPPFLAGS= -I@TOP_SRCDIR@/upcr_geninclude###NOINSTALL###
else
UPCC_GENINCLUDE_CPPFLAGS= -I@TOP_SRCDIR@/upcr_geninclude -I@TOP_BUILDDIR@/upcr_geninclude###NOINSTALL###
endif
UPCC_EXTINCLUDE_CPPFLAGS= -I@TOP_SRCDIR@/upcr_extinclude###NOINSTALL###
UPCC_PRETRANS_CPPFLAGS  = -I@TOP_SRCDIR@/upcr_preinclude @PRETRANS_CPPFLAGS@###NOINSTALL###
UPCC_POSTTRANS_CPPFLAGS = -I@TOP_SRCDIR@/upcr_postinclude $(POSTTRANS_CPPFLAGS)###NOINSTALL###
DETECT_UPC		= $(top_builddir)/detect-upc/detect-upc###NOINSTALL###
PRE_PREPROC		= $(top_builddir)/detect-upc/upcppp###NOINSTALL###
UPCC_UPC_HEADER_DIRS	= -I @TOP_SRCDIR@/upcr_preinclude###NOINSTALL###

ifeq ($(USE_GCCUPC_COMPILER),yes)
    PREPROC = $(GCCUPC) -x upc -E $(UPCR_CPPFLAGS) $(UPCC_EXTINCLUDE_CPPFLAGS) $(EXTRA_CFLAGS)
    COMPILE = $(GCCUPC) -x upc $(EXTRA_CFLAGS)
    HASH_LINE = \# 
else
    # Normal
    ifeq ($(USE_GNU_PREPROC),yes)
	PREPROC = $(GCC_AS_CC) $(UPCR_CPPFLAGS_GENERIC) $(UPCC_PRETRANS_CPPFLAGS)
    else
	PREPROC = $(UPCR_CC) -E $(UPCR_CPPFLAGS) $(UPCC_PRETRANS_CPPFLAGS)
    endif
    COMPILE = $(UPCR_CC) $(UPCR_CFLAGS) $(UPCR_CPPFLAGS) $(UPCC_POSTTRANS_CPPFLAGS)
    HASH_LINE = \# line
endif

LINK = $(UPCR_LD) 

all: link

.SUFFIXES:
.SUFFIXES: .c .o .i .inc .ipre1 .ipre2
.PHONY: force link echovar
.SECONDARY:

force: 

%.ipre1: %.c
	$(PRE_PREPROC) -o '$*.inc' $(UPCC_UPC_HEADER_DIRS) $(UPCPPP_INCLUDEDIRS) '$<'
	$(PREPROC) '$<' >'$@'

# Perl code below performs #line preprocessing:
# - Replace the original .upc source name in place of the temporary .c file name
# - Replace any occurence of '//' in #include pathnames with '/', because some preprocessors have been 
#   observed to treat this as the beginning of a comment and consequently barf on the include directive
%.ipre2: %.ipre1
	@PERL@ -p -e 'BEGIN { print qq|$(HASH_LINE) 1 "<Berkeley UPC @UPCR_VERSION@>"\n|; } ' \
          -e 'if (/^#(?:line)?\s*[0-9]+/) { s)\Q"$(PREPROCNAME)")"$(ORIGNAME)"); s@//@/@g; }' \
          '$<' @PLATFORM_PREPROCESS@ > '$@'

%.i: %.ipre2
	$(DETECT_UPC) $(DETECT_UPC_FLAGS) -i '$*.inc' -o '$@' '$<'

# for trans.c to trans.o 
%.o: %.c
	$(COMPILE) -c '$<'

# GCCUPC compiles to .o directly from .i
%.o: %.i
	$(COMPILE) -c '$<'

link: force
	$(LINK) -o '$(OUT)' $(OBJS) $(UPCR_LDFLAGS) $(UPCR_LIBS) $(GCCUPC_LASTOBJ)

# echo an arbitrary make/environment variable
echovar: force
	@echo $($(VARNAME))

# vim: set ft=automake:
